!function(e,n){if("object"==typeof exports&&"object"==typeof module)module.exports=n(require("fs-extra"),require("path"),require("prompt"),require("ws"),require("events"),require("glob"),require("os"),require("http"));else if("function"==typeof define&&define.amd)define(["fs-extra","path","prompt","ws","events","glob","os","http"],n);else{var t="object"==typeof exports?n(require("fs-extra"),require("path"),require("prompt"),require("ws"),require("events"),require("glob"),require("os"),require("http")):n(e["fs-extra"],e.path,e.prompt,e.ws,e.events,e.glob,e.os,e.http);for(var o in t)("object"==typeof exports?exports:e)[o]=t[o]}}(this,function(e,n,t,o,r,i,a,c){return function(e){function n(o){if(t[o])return t[o].exports;var r=t[o]={exports:{},id:o,loaded:!1};return e[o].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){(function(e){"use strict";function o(e){if(null==e)throw new TypeError("Cannot destructure undefined")}Object.defineProperty(n,"__esModule",{value:!0});var r=t(2),i=t(3),a=t(4),c=t(5),s="../file_template",l="../app_template",u=t(11),p=t(12),d={appTemplateConfig:function(){return p},fileTemplateConfig:function(){return u},startWifi:function(e){var n=e.port;return c.start({port:n})},endWifi:function(e){return o(e),c.end({})},syncWifi:function(e){var n=e.projectPath,t=e.syncAll;return c.sync({project:n,updateAll:t})},previewWifi:function(e){var n=e.file;return n&&""!==n?c.preview({file:n}):void console.error("预览路径不能为空!")},wifiInfo:function e(){var e={ip:c.localIp(),port:c.port,clientsCount:c.clientsCount};return e},wifiLog:function(e){return new Promise(function(n){c.on("log",function(t){e(t),n()})})},init:function(e){var n=e.name,t=e.template,o=e.output;if(n+="",t+="",o+="",!p[t])return void console.error("不支持的模板类型:"+t+" 可选模板: "+Object.keys(p));this.validatePackageName(n);var a=i.resolve(o,n);r.existsSync(a)?this.createAfterConfirmation(n,t,o):this.createProject(n,t,o)},addFileTemplate:function(e){var n=e.name,t=e.output,o=e.template;n+="",t+="",o+="";var a=u[o];if(!a)return void console.error("找不到页面框架模板:"+o+",目前支持的页面模板为:"+Object.keys(u));var c=i.resolve(t),l=i.resolve(t,"config.xml");if(!r.existsSync(c)||!r.existsSync(l))return void console.error(c+" 不是一个有效的APICloud项目!");try{var p=i.join(__dirname,s,a);r.walk(p).on("data",function(e){var t=e.path,o=e.stats,a=i.relative(p,t),s=i.resolve(c,a),l=i.dirname(s);if(!o.isDirectory()){var u=i.basename(s);if(u=u.replace(/apicloudFrame|apicloudWindow(?=\.html)/g,function(e){var t={apicloudFrame:n+"_frame",apicloudWindow:n+"_window"};return t[e]}),s=i.resolve(l,u),r.copySync(t,s,{filter:function(){return!/^[.]+/.test(u)}}),/\.html$/.test(u)){var d=r.readFileSync(s,"utf8");d=d.replace(/apicloudFrame|apicloudWindow/g,function(e){var t={apicloudFrame:n+"_frame",apicloudWindow:n+"_window"};return t[e]}),r.writeFileSync(s,d)}}}).on("end",function(){})}catch(e){return void console.error("创建 APICloud 页面框架失败: "+e)}},validatePackageName:function(e){if(!e.match(/^[\w]{1,20}$/i))return void console.error('"%s" 应用名称无效. 应用名称应在20个字符以内,且不能包含空格和符号!',e)},createAfterConfirmation:function(e,n,t){var o=this;a.start();var r={name:"yesno",message:"目录 "+i.resolve(t,e)+" 已存在. 是否继续?",validator:/[是|否]+/,warning:"必须回复 是 或 否",default:"否"};a.get(r,function(r,i){"是"===i.yesno&&o.createProject(e,n,t)})},createProject:function(e,n,t){var o=i.resolve(t,e);r.existsSync(o)||r.mkdirSync(o);try{var a=i.join(__dirname,l,n);r.copySync(a,o);var c=i.join(o,"config.xml"),s=r.readFileSync(c,"utf8");return s=s.replace(/\<name\>.*\<\/name\>/g,"<name>"+e+"</name>"),void r.writeFileSync(c,s,"utf8")}catch(e){return void console.error("创建APICloud项目失败:"+e)}},_connectHook:null,onconnected:function(e){this._connectHook=e}};c.APICloud=d,n.default=d,e.exports=d,e.export=d}).call(n,t(1)(e))},function(e,n){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},function(e,n){e.exports=require("fs-extra")},function(e,n){e.exports=require("path")},function(e,n){e.exports=require("prompt")},function(e,n,t){"use strict";function o(e){if(null==e)throw new TypeError("Cannot destructure undefined")}var r=t(6).Server,i=t(3),a=t(2),c=t(7),s=-1,l=t(8),u={port:null,socketServer:null,workspace:null,httpServer:null,fileListSynced:{},clientsCount:0,emitter:new c,localIp:function(){var e=t(9),n=e.networkInterfaces(),o=[];for(var r in n)n[r].forEach(function(e,n){"IPv4"===e.family&&"127.0.0.1"!==e.address&&o.push(e.address)});return o},start:function(e){var n=this,o=e.port,c=void 0===o?8686:o,s=t(10).createServer(function(e,t){var o=e.url,r=o.match(/^\/([^\/]+)/);if(!r)return void n.notFound({res:t});var c=r[1];n.projectPath({appId:c,workspace:n.workspace}).then(function(e){if(!e)return void n.notFound({res:t});var r=i.relative("/"+c,o),s=i.resolve(e,r);return!a.existsSync(s)||a.lstatSync(s).isDirectory()?void n.notFound({res:t}):(n.fileListSynced[c]||(n.fileListSynced[c]={}),n.fileListSynced[c][s]||(n.fileListSynced[c][s]=!0),void a.createReadStream(s).pipe(t))})}),l=new r({server:s});this.port=c,this.socketServer=l,this.httpServer=s,l.on("connection",function(e){n.handleConnection({socket:e});var t=n.APICloud._connectHook;t&&t.call(null,n.clientsCount)}),s.listen(c,function(){console.log("APICloud Is Listening on ip: "+JSON.stringify(n.localIp())+" port: "+s.address().port+")")})},end:function(e){o(e),this.socketServer.close(),this.httpServer.close(),console.log("APICloud Wifi 真机同步服务 已关闭...")},handleConnection:function(e){var n=this,t=e.socket;++this.clientsCount,console.log("connection"),console.log("当前连接设备数:"+this.clientsCount),t.send(JSON.stringify({command:7,port:this.port})),t.on("error",function(e){}),t.on("close",function(){console.log("disconnected"),--n.clientsCount,console.log("当前连接设备数:"+n.clientsCount)}),t.on("message",function(e){var o=JSON.parse(e);if(s===o.command){var r=o.payload;r=r||{},r.params.socket=t,n.handleCli(r)}if(4===o.command){var i=n.replyLoaderHeartbeatCmd({command:o.command});n.sendCommand({socket:t,cmd:i})}5===o.command&&heartbeatTimes--,2===o.command&&n.fileListCmd({appId:o.appid,timestamp:o.timestamp,workspace:n.workspace}).then(function(e){n.sendCommand({socket:t,cmd:e})}),8===o.command&&n.handleLog({cmd:o})})},sync:function(e){var n=e.project,t=e.updateAll;if("string"!=typeof n)return void console.log(n+" 不是一个有效的文件路径");var o=i.resolve(n),r=i.resolve(o,"config.xml"),c=i.resolve(o,".."),s=null;if(a.existsSync(r)){var l=a.readFileSync(r,"utf8"),u=l.match(/widget.*id.*=.*(A[0-9]{13})\"/);u&&(s=u[1])}if(!s)return void console.log(n+" 似乎不是一个有效的APICloud项目");this.workspace=c;var p=this.syncCmd({appId:s,updateAll:t});this.broadcastCommand({socketServer:this.socketServer,cmd:p})},preview:function(e){var n=e.file;if("string"!=typeof n)return void console.log(n+" 不是一个有效的文件路径");n=i.resolve(n);for(var t=i.resolve(n,".."),o=null,r=null;!0;){if(o=i.resolve(t,"config.xml"),a.existsSync(o)){var c=a.readFileSync(o,"utf8"),s=c.match(/widget.*id.*=.*(A[0-9]{13})\"/);s&&(r=s[1]);break}if(t===i.resolve("/"))break;t=i.resolve(t,"..")}if(!r)return void console.log(n+" 似乎不在有效的APICloud项目中");this.workspace=i.resolve(t,"..");var l=this.previewCmd({file:n,workspace:this.workspace,appId:r});this.broadcastCommand({socketServer:this.socketServer,cmd:l})},broadcastCommand:function(e){var n=this,t=e.socketServer,o=e.cmd;t.clients.forEach(function(e){n.sendCommand({socket:e,cmd:o})})},sendCommand:function(e){var n=e.socket,t=e.cmd,o=JSON.stringify(t);n.send(o,function(e){})},handleLog:function(e){var n=e.cmd;this.emitter.emit("log",{content:n.content,level:n.level})},on:function(e,n){console.log("on:"+JSON.stringify(e)),this.emitter.on(e,n)},syncCmd:function(e){var n=e.appId,t=e.updateAll,o=void 0===t||t;return{command:1,appid:n,updateAll:o}},globMatch:function(e){var n=e.project,t=e.sync,o=void 0===t?".syncignore":t,r=i.resolve(n,o),c=a.existsSync(r)&&a.readFileSync(r,{encoding:"utf8"})||"",s=l.sync("**",{nodir:!0,ignore:c,realpath:!0,cwd:n});return s},fileListCmd:function(e){var n=this,t=e.appId,o=e.timestamp,r=void 0===o?0:o,i=e.workspace;return new Promise(function(e){n.projectPath({appId:t,workspace:i}).then(function(o){var c=n.globMatch({project:o})||[];c=c.filter(function(e){var o=a.statSync(e),i=o.mtime,c=n.fileListSynced[t];return i.getTime()/1e3>r||!(c&&c[e])}).map(function(e){return n.absoluteUrlPath({file:e,workspace:i,appId:t})}),e({command:3,list:c,timestamp:Math.floor(Date.now()/1e3)})})})},replyLoaderHeartbeatCmd:function(e){var n=e.command;return{command:n}},previewCmd:function(e){var n=e.file,t=e.workspace,o=e.appId,r=this.absoluteUrlPath({file:n,workspace:t,appId:o});return{command:6,path:r,appid:o}},httpPortCmd:function(e){var n=e.port;return{command:7,port:n}},absoluteUrlPath:function e(n){var t=n.file,o=n.workspace,r=n.appId,a=i.relative(o,t);a=a.replace(/\\/g,"/");var e="/"+a.replace(/^[^\/]*/,r);return e},projectPath:function e(n){var t=n.appId,o=n.workspace,e=null;return new Promise(function(n){a.walk(o,{filter:function(e){return i.resolve(o)===i.resolve(e,"./..")}}).on("data",function(e){var o=e.path,r=e.stats,c=i.join(o,"config.xml");if(r.isDirectory()&&a.existsSync(c)){var s=a.readFileSync(c,"utf8"),l=s.match(/widget.*id.*=.*(A[0-9]{13})\"/);l&&t===l[1]&&n(o)}}).on("end",function(){n(e)})})},notFound:function(e){var n=e.res;n.writeHead(404,{"Content-Type":"text/plain"}),n.write("404 Not found"),n.end()},handleCli:function(e){var n=e.method,t=e.params,o=t.socket;"function"==typeof p[n]?p[n](t):(console.log("不支持的方法: "+n),o.close())}},p={wifiSync:function(e){var n=e.project,t=void 0===n?"./":n,o=e.updateAll,r=void 0===o||o,i=e.socket;u.sync({project:t,updateAll:r}),i.close()},wifiStop:function(e){e.socket;u.end({})},wifiPreview:function(e){var n=e.file,t=e.socket;u.preview({file:n}),t.close()},wifiInfo:function e(n){var t=n.socket,e={ip:u.localIp(),port:u.port,clientsCount:u.clientsCount},o={command:s,payload:e};u.sendCommand({socket:t,cmd:o}),t.close()},wifiLog:function(e){var n=e.socket;u.on("log",function(e){var t={command:s,payload:e};u.sendCommand({socket:n,cmd:t})})}};e.exports=u},function(e,n){e.exports=require("ws")},function(e,n){e.exports=require("events")},function(e,n){e.exports=require("glob")},function(e,n){e.exports=require("os")},function(e,n){e.exports=require("http")},function(e,n){e.exports={page001:"dianping-classify",page002:"dianping-group",page003:"dianping-home",page004:"dianping-info",page005:"dianping-merchant",page006:"dianping-mine",page007:"dianping-movie",page008:"dianping-orderDetail",page009:"souhu-hot",page010:"souhu-recommend",page011:"tianmao-home",page012:"tianmao-mine",page013:"tianmao-shopping",page014:"wangyimusic-down",page015:"elema-1",page016:"elema-2",page017:"qiushibaike",page018:"qq-movie-1",page019:"qq-movie-2",page020:"tuniu-1",page021:"tuniu-2",page022:"wangyi-music",page023:"wangyi-news-1",page024:"wangyi-news-2",page025:"wangyi-news-3",page026:"wangyi-news-4"}},function(e,n){e.exports={default:"空白应用",bottom:"底部导航",home:"首页导航",slide:"侧边导航"}}])});